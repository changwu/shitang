# 工作日每日早上打卡和午餐消费统计查询（排除周六周日）

## 查询功能
统计工作日（周一到周五）每天车辆和人员早上9点前打卡人员个数和午餐消费人数，已排除周六和周日数据。

## SQL查询文件
- `daily_morning_checkins_and_lunch_weekdays_clean.sql` - 工作日版（推荐）
- `daily_morning_checkins_and_lunch_complete.sql` - 完整版（含周末）

## 主要改进

### 1. 周末数据排除
- 使用 `EXTRACT(DOW FROM record_date) BETWEEN 1 AND 5` 仅筛选工作日
- 0=周日，6=周六，1-5=周一到周五

### 2. 星期标识
- 自动显示星期几（周一、周二、周三、周四、周五）
- 便于识别数据模式和异常

### 3. 查询结果示例

```
    日期    | 星期 | 早上9点前车辆打卡人数 | 早上9点前人员打卡人数 | 早上9点前总打卡人数 | 午餐消费人数 | 午餐消费率(%)
------------+------+-----------------------+-----------------------+---------------------+--------------+---------------
 2025-11-24 | 周一 |                    84 |                   189 |                 273 |          313 |         114.7
 2025-11-21 | 周五 |                    75 |                   203 |                 278 |          306 |         110.1
 2025-11-20 | 周四 |                    76 |                   190 |                 266 |          297 |         111.7
```

## 工作日数据洞察

### 1. 打卡规律
- **周一**：通常人数较多（273-290人），周末后返工
- **周五**：人数稳定（278人左右），周末前工作日
- **中间日**：周二至周四人数相对稳定（266-285人）

### 2. 午餐消费特征
- **消费率**：工作日午餐消费率通常在90-120%之间
- **周一较高**：114.7%，可能包含周末未打卡人员
- **周五稳定**：110%左右，正常工作日模式

### 3. 数据质量
- **完整性**：仅显示有数据的日期，避免空值
- **准确性**：使用DISTINCT去重，确保每人只统计一次
- **一致性**：数据覆盖完整的工作日周期

## 查询优化特点

### 性能优化
- ✅ **早期过滤**：在WHERE子句中提前过滤工作日数据
- ✅ **索引利用**：充分利用现有时间索引
- ✅ **分步CTE**：使用多个CTE分步处理，提高可读性

### 数据准确性
- ✅ **时间精确筛选**：`EXTRACT(HOUR FROM record_date) < 9`
- ✅ **工作日过滤**：`EXTRACT(DOW FROM record_date) BETWEEN 1 AND 5`
- ✅ **去重统计**：`COUNT(DISTINCT name)` 避免重复计数
- ✅ **空值处理**：`COALESCE` 确保数据完整性

## 使用建议

1. **定期运行**：建议每周或每月运行此查询
2. **异常监控**：关注午餐消费率异常（如低于90%或高于130%）
3. **趋势分析**：可按周汇总分析长期趋势
4. **对比分析**：与完整版对比，了解周末数据影响
5. **可视化展示**：在Metabase中创建图表，排除周末数据干扰

## 更新说明

本次更新主要解决了用户要求：
- ❌ 去除了周六、周日数据
- ✅ 保留了完整的工作日统计
- ✅ 增加了星期标识便于识别
- ✅ 优化了查询性能和可读性